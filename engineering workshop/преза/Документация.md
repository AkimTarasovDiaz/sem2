# **Документация к multiroute_view_access.html**

## **Основные функции карты и маркеров**

1. **`setupMarkerDragEvents(marker, isZoneMarker)`**

   - **Назначение**: Обработка событий перетаскивания маркеров.
   - **Параметры**:
     - `marker`: Объект маркера на карте.
     - `isZoneMarker`: Флаг, указывающий, относится ли маркер к запретной зоне.
   - **Логика**:
     - При начале перетаскивания (`dragstart`) временно удаляет полилинию маршрута или зоны.
     - При перемещении (`drag`) обновляет popup с координатами.
     - После завершения (`dragend`) обновляет полилинию.
2. **`updatePolyline()`**

   - **Назначение**: Обновляет линию маршрута, соединяющую точки.
   - **Логика**:
     - Удаляет старую полилинию (если есть).
     - Создает новую полилинию на основе текущих маркеров.
3. **`updateZonePolyline()`**

   - **Назначение**: Обновляет линию запретной зоны.
   - **Логика**:
     - Аналогична `updatePolyline()`, но для зон.
     - Если зона почти замкнута (расстояние между первой и последней точкой < 20 м), автоматически замыкает полигон.
4. **`showZoneError(message)`**

   - **Назначение**: Показывает всплывающее сообщение об ошибке.
   - **Параметры**:
     - `message`: Текст ошибки.
   - **Особенности**:
     - Автоматически исчезает через 5 секунд.
     - Можно закрыть вручную (крестик).
5. **`updateMarkerNumbers()`**

   - **Назначение**: Перенумеровывает маркеры маршрута.
   - **Логика**:
     - Обновляет иконки маркеров (цифры 1, 2, 3...) и их popup-окна.
6. **`removeMarker(marker)`**

   - **Назначение**: Удаляет точку маршрута.
   - **Логика**:
     - Удаляет маркер с карты и из массива `markers`.
     - Обновляет полилинию и нумерацию.
7. **`isPointInZones(latlng)`**

   - **Назначение**: Проверяет, находится ли точка внутри запретной зоны.
   - **Возвращает**: `true`/`false`.

## **Функции работы с запретными зонами**

8. **`finishZone()`**

   - **Назначение**: Завершает создание зоны.
   - **Логика**:
     - Проверяет, что точек достаточно (минимум 2).
     - Замыкает полигон (если не замкнут).
     - Создает красный полигон на карте.
9. **`cancelZone()`**

   - **Назначение**: Отменяет создание зоны.
   - **Логика**:
     - Удаляет временные маркеры и полилинию.
10. **`removeZoneMarker(marker)`**

    - **Назначение**: Удаляет точку зоны.
    - **Логика**:
      - Аналогична `removeMarker()`, но для зон.
11. **`removeSpecificZone(zone)`**

    - **Назначение**: Удаляет конкретную зону.
    - **Параметры**:
      - `zone`: Объект полигона зоны.
12. **`getPolygonCentroid(latlngs)`**

    - **Назначение**: Вычисляет геометрический центр полигона.
    - **Возвращает**: Координаты центра (`L.latLng`).

## **Вспомогательные функции**

13. **`createNumberedIcon(number, isZone)`**

    - **Назначение**: Создает иконку маркера с номером.
    - **Параметры**:
      - `number`: Номер маркера.
      - `isZone`: Флаг для стиля зоны (красный).
14. **`showCoordinates(latlng)`**

    - **Назначение**: Показывает модальное окно с координатами.
    - **Параметры**:
      - `latlng`: Объект координат.
15. **`setupMarkerContextMenu(marker)`**

    - **Назначение**: Добавляет контекстное меню для маркера.
    - **Логика**:
      - Показывает опции:
        - "Показать координаты".
        - "Удалить точку".

## **Обработчики событий карты**

16. **`map.on('click')`**

    - **Логика**:
      - В режиме добавления зоны: создает маркеры зоны.
      - В обычном режиме: добавляет точки маршрута.
      - Автоматически замыкает маршрут/зону при клике рядом с первой точкой.
17. **`map.on('contextmenu')`**

    - **Логика**:
      - Для зон: показывает меню с опциями удаления/просмотра.
      - Для маркеров: вызывает `setupMarkerContextMenu()`.

## **Управление интерфейсом**

18. **Кнопки в sidebar**:

    - **`add-zone`**: Активирует режим добавления зоны.
    - **`clear-markers`**: Удаляет все точки маршрута.
    - **`clear-zones`**: Удаляет все зоны.
    - **`arm-button`**: Открывает модальное окно управления БПЛА.
19. **Модальное окно**:

    - Показывает статус БПЛА.
    - Кнопки: `Arm`, `Disarm`, `Kill switch`.

## **Глобальные переменные**

- **`map`**: Объект карты Leaflet.
- **`markers`**: Массив точек маршрута.
- **`zoneMarkers`**: Массив точек зон.
- **`zones`**: Массив полигонов зон.
- **`polyline`**, **`zonePolyline`**: Линии маршрута и зон.
- **`isAddingZone`**: Флаг режима добавления зоны.
